#!/bin/bash

set -eu

# supercronic daemon must be running
if ["$(s6-svstat -o up /run/s6/services/supercronic)" == "false"]; then
	>&2 printf '%s\n' 'supercronic daemon is not running'
	exit 1
fi

for ((ii=1; ii<=KRESD_NUM_INSTANCES; ii++)); do
  # kresd daemon must be running
  if ["$(s6-svstat -o up /run/s6/services/kresd${ii})" == "false"]; then
    >&2 printf '%s\n' 'kresd${ii} daemon is not running'
    exit 1
  fi
done

# kres-cache-gc daemon must be running
if ["$(s6-svstat -o up /run/s6/services/kres-cache-gc)" == "false"]; then
	>&2 printf '%s\n' 'kres-cache-gc daemon is not running'
	exit 1
fi

# DNS server must resolve localhost A record
if [ "$(kdig @127.0.0.1 -p 53 +short +time=1 +retry=0 localhost A)" != 127.0.0.1 ]; then
	>&2 printf '%s\n' 'DNS server returned an unexpected result'
	exit 1
fi

# DNS (over TLS) server must resolve localhost A record
if [ "$(kdig @127.0.0.1 -p 853 +tls +short +time=1 +retry=0 localhost A)" != 127.0.0.1 ]; then
	>&2 printf '%s\n' 'DNS (over TLS) server returned an unexpected result'
	exit 1
fi

# HTTP server must return "OK"
if [ "$(curl -kfs https://localhost:8453/health)" != OK ]; then
	>&2 printf '%s\n' 'HTTP server returned an unexpected result'
	exit 1
fi
